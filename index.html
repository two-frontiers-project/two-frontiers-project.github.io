<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2FP Open Tools & Protocols</title>
  <meta name="description" content="Two Frontiers Project - Open source research tools and protocols">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f1419;
      color: #e6edf3;
      line-height: 1.6;
      font-size: 18px;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
      padding: 2rem 0;
      border-bottom: 1px solid #30363d;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      max-height: 60px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .header-title {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #58a6ff, #79c0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    /* Main Layout */
    .main-container {
      display: flex;
      min-height: calc(100vh - 120px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    /* Navigation Sidebar */
    .nav-sidebar {
      width: 350px;
      background: #161b22;
      border-right: 1px solid #30363d;
      padding: 2rem 0;
      overflow-y: auto;
      position: sticky;
      top: 120px;
      height: calc(100vh - 120px);
    }
    
    .nav-section {
      margin-bottom: 1.5rem;
    }
    
    .nav-section-header {
      background: linear-gradient(135deg, #21262d, #30363d);
      color: #f0f6fc;
      padding: 1rem 1.5rem;
      margin: 0 1rem 1rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #484f58;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .nav-section-header:hover {
      background: linear-gradient(135deg, #30363d, #484f58);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .nav-section-header.active {
      background: linear-gradient(135deg, #1f6feb, #388bfd);
      border-color: #58a6ff;
    }
    
    .toggle-icon {
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }
    
    .nav-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin: 0 1rem;
    }
    
    .nav-section-content.expanded {
      max-height: 1000px;
    }
    
    .nav-item {
      padding: 0.75rem 1.5rem;
      margin: 0.25rem 0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #8b949e;
      font-size: 1rem;
    }
    
    .nav-item:hover {
      background: #21262d;
      color: #f0f6fc;
      transform: translateX(4px);
    }
    
    .nav-item.active {
      background: #1f6feb;
      color: #ffffff;
    }
    
    .nav-subitem {
      padding: 0.5rem 1.5rem 0.5rem 3rem;
      margin: 0.125rem 0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #7d8590;
      font-size: 0.95rem;
      border-left: 2px solid transparent;
    }
    
    .nav-subitem:hover {
      background: #21262d;
      color: #f0f6fc;
      border-left-color: #58a6ff;
      transform: translateX(4px);
    }
    
    .nav-subitem.active {
      background: #1f6feb;
      color: #ffffff;
      border-left-color: #ffffff;
    }
    
    .nav-subitem.subdirectory {
      padding-left: 4rem !important;
      color: #6a737d !important;
      font-size: 0.9rem !important;
    }
    
    /* Content Area */
    .content-area {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .section-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #58a6ff, #79c0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .section-description {
      font-size: 1.2rem;
      color: #8b949e;
      margin-bottom: 2rem;
      line-height: 1.7;
    }
    
    .handbook-download-section {
      text-align: center;
      margin: 2rem 0;
    }
    
    .handbook-download-main {
      display: inline-block;
      background: linear-gradient(135deg, #1f6feb, #388bfd);
      color: white;
      padding: 1.5rem 3rem;
      border-radius: 14px;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.3rem;
      transition: all 0.3s ease;
      box-shadow: 0 6px 24px rgba(31, 110, 235, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      min-width: 350px;
      position: relative;
      overflow: hidden;
    }
    
    .handbook-download-main::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .handbook-download-main:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(31, 111, 235, 0.6);
      color: white;
      text-decoration: none;
      background: linear-gradient(135deg, #388bfd, #1f6feb);
    }
    
    .handbook-download-main:hover::before {
      left: 100%;
    }
    
    /* Custom Scrollbar */
    .nav-sidebar::-webkit-scrollbar {
      width: 8px;
    }
    
    .nav-sidebar::-webkit-scrollbar-track {
      background: #0d1117;
    }
    
    .nav-sidebar::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 4px;
    }
    
    .nav-sidebar::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
    
    /* Markdown Content Styling */
    .markdown-content {
      line-height: 1.7;
      color: #e6edf3;
    }
    
    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
      color: #f0f6fc;
      margin: 1.5rem 0 1rem 0;
      font-weight: 600;
    }
    
    .markdown-content h1 {
      font-size: 2rem;
      border-bottom: 2px solid #30363d;
      padding-bottom: 0.5rem;
    }
    
    .markdown-content h2 {
      font-size: 1.75rem;
      border-bottom: 1px solid #30363d;
      padding-bottom: 0.3rem;
    }
    
    .markdown-content h3 {
      font-size: 1.5rem;
    }
    
    .markdown-content p {
      margin-bottom: 1rem;
      color: #e6edf3;
    }
    
    .markdown-content ul,
    .markdown-content ol {
      margin: 1rem 0;
      padding-left: 2rem;
    }
    
    .markdown-content li {
      margin-bottom: 0.5rem;
      color: #e6edf3;
    }
    
    .markdown-content strong {
      color: #f0f6fc;
      font-weight: 600;
    }
    
    .markdown-content em {
      color: #8b949e;
      font-style: italic;
    }
    
    .markdown-content a {
      color: #58a6ff;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s ease;
    }
    
    .markdown-content a:hover {
      border-bottom-color: #58a6ff;
    }
    
    .markdown-content blockquote {
      border-left: 4px solid #58a6ff;
      margin: 1.5rem 0;
      padding: 0.5rem 0 0.5rem 1.5rem;
      background: rgba(88, 166, 255, 0.1);
      border-radius: 0 4px 4px 0;
    }
    
    .markdown-content blockquote p {
      margin: 0;
      color: #8b949e;
      font-style: italic;
    }
    
    .markdown-content code {
      background: #21262d;
      color: #f0f6fc;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.9em;
    }
    
    .markdown-content pre {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 1rem;
      overflow-x: auto;
      margin: 1.5rem 0;
    }
    
    .markdown-content pre code {
      background: none;
      padding: 0;
      color: #e6edf3;
    }
    
    /* Table Styling */
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5rem 0;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .markdown-content th {
      background: #21262d;
      color: #f0f6fc;
      font-weight: 600;
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    
    .markdown-content td {
      padding: 0.75rem;
      border-bottom: 1px solid #30363d;
      color: #e6edf3;
    }
    
    .markdown-content tr:nth-child(even) {
      background: #161b22;
    }
    
    .markdown-content tr:hover {
      background: #21262d;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
      }
      
      .nav-sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        max-height: 400px;
      }
      
      .content-area {
        padding: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      .header-title {
        font-size: 2rem;
      }
      
      .section-title {
        font-size: 2rem;
      }
      
      .content-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <img src="images/2FP-Logo-MainLogo-COLOR-2063x500.png" alt="Two Frontiers Project" class="logo" onclick="showContent('home')" style="cursor: pointer;">
      <h1 class="header-title">2FP Open Tools & Protocols</h1>
    </div>
    
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Navigation Sidebar -->
    <nav class="nav-sidebar" id="nav-sidebar">
      <!-- Navigation will be dynamically generated from _sidebar.md -->
      <div class="nav-section">
        <div class="nav-section-header" onclick="toggleSection('overview')">
          Overview
          <span class="toggle-icon">▼</span>
        </div>
        <div class="nav-section-content" id="overview-content">
          <div class="nav-item" onclick="showContent('home')">Welcome</div>
          <div class="nav-item" onclick="showContent('about')">About 2FP</div>
        </div>
      </div>
      
      <!-- Dynamic sections will be loaded here -->
    </nav>

    <!-- Content Area -->
    <main class="content-area">
      <!-- Home Content -->
      <div class="content-section active" id="home">
        <div id="home-content">
          <!-- Content will be loaded here -->
        </div>
      </div>

      <!-- Content Placeholder -->
      <div class="content-section" id="content-placeholder">
        <h1 class="section-title">Content Loading...</h1>
        <p class="section-description">Select a section from the navigation to view its content.</p>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Configure marked.js for better rendering
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: true,
      mangle: false
    });
    
    // Navigation functionality
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId + '-content');
      const header = content.previousElementSibling;
      const icon = header.querySelector('.toggle-icon');
      
      // Close all other sections
      document.querySelectorAll('.nav-section-content').forEach(section => {
        if (section !== content) {
          section.classList.remove('expanded');
          section.previousElementSibling.classList.remove('active');
          section.previousElementSibling.querySelector('.toggle-icon').textContent = '▼';
        }
      });
      
      // Toggle current section
      content.classList.toggle('expanded');
      header.classList.toggle('active');
      icon.textContent = content.classList.contains('expanded') ? '▲' : '▼';
    }
    
    function showContent(contentId) {
      // Hide all content sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item, .nav-subitem').forEach(item => {
        item.classList.remove('active');
      });
      
      // Add active class to clicked item
      event.target.classList.add('active');
      
      // Handle special content cases
      if (contentId === 'home') {
        // For home, show the home section and load README content
        document.getElementById('home').classList.add('active');
        loadContentFromLink('/README.md', 'Welcome to 2FP Open Tools');
      } else if (contentId === 'about') {
        loadAbout2FP();
      } else {
        // Load and display actual content
        loadContent(contentId);
      }
    }
    
    async function loadContent(contentId) {
      const contentArea = document.querySelector('.content-area');
      
      // Show loading state
      contentArea.innerHTML = `
        <div class="content-section active" id="loading">
          <h1 class="section-title">Loading Content...</h1>
          <p class="section-description">Please wait while we load the requested content.</p>
        </div>
      `;
      
      try {
        let content = '';
        let title = '';
        
        // Determine what content to load based on contentId
        if (contentId.startsWith('handbook-')) {
          const section = contentId.replace('handbook-', '');
          const filename = getHandbookFilename(section);
          if (filename) {
            const response = await fetch(`external/2FP-Field-Handbook/${filename}`);
            if (response.ok) {
              content = await response.text();
              title = getHandbookTitle(section);
            }
          }
        } else if (contentId.startsWith('kits-')) {
          const section = contentId.replace('kits-', '');
          const filename = getKitsFilename(section);
          if (filename) {
            const response = await fetch(`external/2FP-fieldKitsAndProtocols/${filename}/README.md`);
            if (response.ok) {
              content = await response.text();
              title = getKitsTitle(section);
            }
          }
        } else if (contentId.startsWith('hardware-')) {
          const section = contentId.replace('hardware-', '');
          const filename = getHardwareFilename(section);
          if (filename) {
            const response = await fetch(`external/${filename}/README.md`);
            if (response.ok) {
              content = await response.text();
              title = getHardwareTitle(section);
            }
          }
        } else if (contentId.startsWith('software-')) {
          const section = contentId.replace('software-', '');
          const filename = getSoftwareFilename(section);
          if (filename) {
            const response = await fetch(`external/${filename}/README.md`);
            if (response.ok) {
              content = await response.text();
              title = getSoftwareTitle(section);
            }
          }
        } else if (contentId.startsWith('templates-')) {
          const section = contentId.replace('templates-', '');
          const filename = getTemplatesFilename(section);
          if (filename) {
            const response = await fetch(`external/${filename}/README.md`);
            if (response.ok) {
              content = await response.text();
              title = getTemplatesTitle(section);
            }
          }
        }
        
        if (content) {
          // Convert markdown to HTML using marked.js and display
          const htmlContent = marked.parse(content);
          contentArea.innerHTML = `
            <div class="content-section active" id="${contentId}">
              <h1 class="section-title">${title}</h1>
              <div class="markdown-content">
                ${htmlContent}
              </div>
            </div>
          `;
          
          // Fix any internal links to point to local files
          fixInternalLinks(contentId);
        } else {
          // Show error if content couldn't be loaded
          contentArea.innerHTML = `
            <div class="content-section active" id="error">
              <h1 class="section-title">Content Not Found</h1>
              <p class="section-description">The requested content could not be loaded. Please try another section.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading content:', error);
        contentArea.innerHTML = `
          <div class="content-section active" id="error">
            <h1 class="section-title">Error Loading Content</h1>
            <p class="section-description">There was an error loading the requested content. Please try again.</p>
          </div>
        `;
      }
    }
    
    // Helper functions to map content IDs to filenames and titles
    function getHandbookFilename(section) {
      const mapping = {
        'about': '01-about-this-handbook.md',
        'planning': '02-expedition-planning.md',
        'identifiers': '03-sample-identifiers-and-site-metadata.md',
        'preparation': '04-preparation-for-sample-collection.md',
        'lab': '05-setting-up-a-field-processing-lab.md',
        'collection': '06-sample-collection.md',
        'checkin': '07-sample-check-in.md',
        'processing': '08-sample-processing-and-preservation.md',
        'transport': '09-sample-transportation.md',
        'debrief': '10-post-sampling-reset-and-team-debrief.md'
      };
      return mapping[section];
    }
    
    function getHandbookTitle(section) {
      const mapping = {
        'about': 'About This Handbook',
        'planning': 'Expedition Planning',
        'identifiers': 'Sample Identifiers and Site Metadata',
        'preparation': 'Preparation for Sample Collection',
        'lab': 'Setting Up a Field Processing Lab',
        'collection': 'Sample Collection',
        'checkin': 'Sample Check-in',
        'processing': 'Sample Processing and Preservation',
        'transport': 'Sample Transportation',
        'debrief': 'Post-Sampling Reset and Team Debrief'
      };
      return mapping[section];
    }
    
    function getKitsFilename(section) {
      const mapping = {
        'citizen': 'citizen_science_extremophiles_in_the_home',
        '10sample': 'kit_10sample_collection-nobanking'
      };
      return mapping[section];
    }
    
    function getKitsTitle(section) {
      const mapping = {
        'citizen': 'Citizen Science Extremophiles in the Home',
        '10sample': '10-Sample Collection Kit'
      };
      return mapping[section];
    }
    
    function getHardwareFilename(section) {
      const mapping = {
        'od600': '2FP-fieldworkToolsGeneral/OD600',
        'cuvette': '2FP-cuvette_holder',
        '3dprinting': '2FP-3dPrinting',
        'puma': '2FP-PUMA',
        'xtree': '2FP-XTree'
      };
      return mapping[section];
    }
    
    function getHardwareTitle(section) {
      const mapping = {
        'od600': 'OD600 Measurement',
        'cuvette': 'Cuvette Holder',
        '3dprinting': '3D Printing',
        'puma': 'PUMA',
        'xtree': 'XTree'
      };
      return mapping[section];
    }
    
    function getSoftwareFilename(section) {
      const mapping = {
        'magus': '2FP_MAGUS'
      };
      return mapping[section];
    }
    
    function getSoftwareTitle(section) {
      const mapping = {
        'magus': 'MAGUS'
      };
      return mapping[section];
    }
    
    function getTemplatesFilename(section) {
      const mapping = {
        'expedition': '2FP-expedition-template',
        'field': '2FP-Field-Handbook'
      };
      return mapping[section];
    }
    
    function getTemplatesTitle(section) {
      const mapping = {
        'expedition': 'Expedition Template',
        'field': 'Field Handbook'
      };
      return mapping[section];
    }
    
    // Fix internal links to point to local files
    function fixInternalLinks(contentId) {
      const contentDiv = document.querySelector('.markdown-content');
      if (!contentDiv) return;
      
      // Fix links to handbook files
      const handbookLinks = contentDiv.querySelectorAll('a[href*="github.com/two-frontiers-project/2FP-Field-Handbook"]');
      handbookLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href.includes('blob/main/')) {
          const filename = href.split('blob/main/')[1];
          link.href = `external/2FP-Field-Handbook/${filename}`;
          link.target = '_blank';
        }
      });
      
      // Fix relative links to other markdown files
      const relativeLinks = contentDiv.querySelectorAll('a[href$=".md"]');
      relativeLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href.startsWith('http') && !href.startsWith('#')) {
          if (contentId.startsWith('handbook-')) {
            link.href = `external/2FP-Field-Handbook/${href}`;
          }
          link.target = '_blank';
        }
      });
    }
    
    // Load navigation from _sidebar.md
    async function loadNavigation() {
      try {
        const response = await fetch('_sidebar.md');
        const sidebarContent = await response.text();
        
        // Parse the markdown to extract sections and items
        const sections = parseSidebarMarkdown(sidebarContent);
        

        
        // Generate navigation HTML
        const navSidebar = document.getElementById('nav-sidebar');
        const overviewSection = navSidebar.querySelector('.nav-section');
        
        // Add dynamic sections after the overview section
        sections.forEach(section => {
          if (section.title !== 'Overview') {
            const sectionHtml = createNavigationSection(section);
            navSidebar.appendChild(sectionHtml);
          }
        });
        
        // Expand overview section by default
        toggleSection('overview');
        
      } catch (error) {
        console.error('Error loading navigation:', error);
      }
    }
    
    // Parse _sidebar.md content into structured data
    function parseSidebarMarkdown(content) {
      const lines = content.split('\n');
      const sections = [];
      let currentSection = null;
      let currentItem = null;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();
        
        // Check for section headers (## Title)
        if (trimmed.startsWith('## ')) {
          const title = trimmed.substring(3);
          currentSection = {
            title: title,
            items: []
          };
          sections.push(currentSection);
          currentItem = null;
        }
        // Check for main items (- [Title](link))
        else if (trimmed.startsWith('- [') && currentSection) {
          const match = trimmed.match(/- \[([^\]]+)\]\(([^)]+)\)/);
          if (match) {
            const itemTitle = match[1];
            const itemLink = match[2];
            
            currentItem = {
              title: itemTitle,
              link: itemLink,
              subItems: []
            };
            currentSection.items.push(currentItem);
          }
        }
        // Check for sub-items (indented with 2 spaces:   - [Title](link))
        else if (line.startsWith('  - [') && currentItem) {
          const subMatch = line.match(/  - \[([^\]]+)\]\(([^)]+)\)/);
          if (subMatch) {
            currentItem.subItems.push({
              title: subMatch[1],
              link: subMatch[2],
              isSubdirectory: true
            });
          }
        }
      }
      
      // Manually fix the subdirectory structure based on known hierarchy
      sections.forEach(section => {
        if (section.title === 'Hardware') {
          section.items.forEach(item => {
            if (item.title === 'General 3D Printing') {
              // All sub-items under General 3D Printing are subdirectories
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            } else if (item.title === 'PUMA Scope') {
              // Freecad is a subdirectory
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            } else if (item.title === 'General Field Tools') {
              // Uvspec and Od600 are subdirectories
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            }
          });
        } else if (section.title === 'The Two Frontiers Handbook') {
          // All sub-items under Handbook are subdirectories
          section.items.forEach(item => {
            if (item.title === '2FP Field Handbook and Standards') {
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            }
          });
        } else if (section.title === 'Speciality Kits') {
          // All sub-items under Speciality Kits are subdirectories
          section.items.forEach(item => {
            if (item.title === 'Speciality Kits') {
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            }
          });
        } else if (section.title === 'Templates') {
          // All sub-items under Templates are subdirectories
          section.items.forEach(item => {
            if (item.title === 'Expedition Template') {
              item.subItems.forEach(subItem => {
                subItem.isSubdirectory = true;
              });
            }
          });
        }
      });
      
      return sections;
    }
    
    // Create navigation section HTML
    function createNavigationSection(section) {
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'nav-section';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'nav-section-header';
      headerDiv.onclick = () => toggleSection(section.title.toLowerCase().replace(/\s+/g, '-'));
      headerDiv.innerHTML = `
        ${section.title}
        <span class="toggle-icon">▼</span>
      `;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'nav-section-content';
      contentDiv.id = section.title.toLowerCase().replace(/\s+/g, '-') + '-content';
      
      // Add main items
      section.items.forEach((item, index) => {
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'nav-item';
        itemDiv.onclick = () => showContentFromLink(item.link, item.title);
        itemDiv.textContent = item.title;
        contentDiv.appendChild(itemDiv);
        
        // Add sub-items if they exist
        if (item.subItems && item.subItems.length > 0) {
          item.subItems.forEach((subItem, subIndex) => {
            
            const subItemDiv = document.createElement('div');
            subItemDiv.className = 'nav-subitem';
            
            // Manually set indentation based on known subdirectory structure
            if (subItem.isSubdirectory) {
              subItemDiv.classList.add('subdirectory');
              // Add visual indentation with spaces and a dash
              subItemDiv.textContent = '     - ' + subItem.title;
            } else {
              subItemDiv.textContent = subItem.title;
            }
            
            subItemDiv.onclick = () => showContentFromLink(subItem.link, subItem.title);
            contentDiv.appendChild(subItemDiv);
          });
        }
      });
      
      sectionDiv.appendChild(headerDiv);
      sectionDiv.appendChild(contentDiv);
      return sectionDiv;
    }
    
    // Show content from a link (instead of contentId)
    function showContentFromLink(link, title) {
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item, .nav-subitem').forEach(item => {
        item.classList.remove('active');
      });
      
      // Add active class to clicked item
      event.target.classList.add('active');
      
      // Load content directly from the link
      loadContentFromLink(link, title);
    }
    
    // Load content from a specific link
    async function loadContentFromLink(link, title) {
      let targetElement;
      
      // If loading README for home page, load into home-content div
      if (link === '/README.md') {
        targetElement = document.querySelector('#home-content');
        if (!targetElement) {
          // Fallback to content area if home-content doesn't exist
          targetElement = document.querySelector('.content-area');
        }
      } else {
        targetElement = document.querySelector('.content-area');
      }
      
      // Show loading state
      if (link === '/README.md') {
        targetElement.innerHTML = `
          <div class="loading-content">
            <h1 class="section-title">Loading...</h1>
            <p class="section-description">Please wait while we load the content.</p>
          </div>
        `;
      } else {
        targetElement.innerHTML = `
          <div class="content-section active" id="loading">
            <h1 class="section-title">Loading Content...</h1>
            <p class="section-description">Please wait while we load the requested content.</p>
          </div>
        `;
      }
      
      try {
        // Handle different link types
        let content = '';
        let actualTitle = title;
        
        if (link.startsWith('external/')) {
          const response = await fetch(link);
          if (response.ok) {
            content = await response.text();
          }
        } else if (link === '/README.md') {
          const response = await fetch('README.md');
          if (response.ok) {
            content = await response.text();
            actualTitle = 'Welcome to 2FP Open Tools';
          }
        }
        
        if (content) {
          // Convert markdown to HTML using marked.js and display
          const htmlContent = marked.parse(content);
          
          if (link === '/README.md') {
            // For home page, load into home-content div
            targetElement.innerHTML = `
              <div class="markdown-content">
                ${htmlContent}
              </div>
            `;
            
            // Force apply button styling to the download link
            setTimeout(() => {
              const downloadLink = targetElement.querySelector('a[href*="2FP_handbook_V11.pdf"]');
              if (downloadLink) {
                downloadLink.style.cssText = `
                  display: inline-block !important;
                  background: linear-gradient(135deg, #1f6feb, #388bfd) !important;
                  color: white !important;
                  padding: 1.5rem 3rem !important;
                  border-radius: 14px !important;
                  text-decoration: none !important;
                  font-weight: 700 !important;
                  font-size: 1.3rem !important;
                  transition: all 0.3s ease !important;
                  box-shadow: 0 6px 24px rgba(31, 110, 235, 0.4) !important;
                  border: 2px solid rgba(255, 255, 255, 0.1) !important;
                  text-align: center !important;
                  min-width: 350px !important;
                  position: relative !important;
                  overflow: hidden !important;
                `;
              }
            }, 100);
          } else {
            // For other content, load into content area
            targetElement.innerHTML = `
              <div class="content-section active" id="content-loaded">
                <div class="markdown-content">
                  ${htmlContent}
                </div>
              </div>
            `;
          }
          
          // Fix any internal links
          fixInternalLinksFromContent(link);
        } else {
          if (link === '/README.md') {
            targetElement.innerHTML = `
              <div class="error-content">
                <h1 class="section-title">Content Not Found</h1>
                <p class="section-description">The README content could not be loaded.</p>
              </div>
            `;
          } else {
            targetElement.innerHTML = `
              <div class="content-section active" id="error">
                <h1 class="section-title">Content Not Found</h1>
                <p class="section-description">The requested content could not be loaded. Please try another section.</p>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading content:', error);
        if (link === '/README.md') {
          targetElement.innerHTML = `
            <div class="error-content">
              <h1 class="section-title">Error Loading Content</h1>
              <p class="section-description">There was an error loading the README content.</p>
            </div>
          `;
        } else {
          targetElement.innerHTML = `
            <div class="content-section active" id="error">
              <h1 class="section-title">Error Loading Content</h1>
              <p class="section-description">There was an error loading the requested content. Please try again.</p>
            </div>
          `;
        }
      }
    }
    
            // Load About 2FP content
        function loadAbout2FP() {
          const contentArea = document.querySelector('.content-area');
          
          const aboutContent = `
            <div class="content-section active" id="about">
              <h1 class="section-title">About Two Frontiers Project</h1>
              <div class="markdown-content">
                <p>The <strong>Two Frontiers Project</strong> (2FP, <a href="https://twofrontiers.org/" target="_blank">https://twofrontiers.org/</a>) is a 501 c(3), non-profit research organization dedicated to advancing human and environmental health by harnessing the potential of microbial life, from sea to space. Microbes are nature's alchemists: they remove contaminants from the environment, capture greenhouse gases, improve crop yields, and refine rare Earth minerals. Through expeditions around the globe, <strong>we find and scale these microbial machines to macro-scale impact</strong>, aiming to address major societal challenges in human and planetary health, emphasizing pollutant remediation, coral reef bleaching, and sustainable agriculture.</p>
                
                <h2>2FP Research Initiatives</h2>
                
                <table>
                  <thead>
                    <tr>
                      <th style="text-align: center;">Carbon</th>
                      <th>Removing greenhouse gases from the atmosphere is needed to fight climate change. Searching across four continents, We have found some of the <a href="https://www.synbiobeta.com/read/meet-chonkus-the-algae-that-eats-carbon-and-sinks-like-a-rock" target="_blank">most efficient carbon-capturing organisms ever observed</a> that can efficiently reduce greenhouse gas (carbon dioxide and methane) emissions.</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="text-align: center;"><strong>Coral</strong></td>
                      <td>We need more tools to protect our reefs from an increasingly polluted and warming ocean. In our Coral Initiative, we do so by sequencing, culturing, and deploying microbial communities that enhance reef resilience to disease and heat-stress.</td>
                    </tr>
                    <tr>
                      <td style="text-align: center;"><strong>Crops</strong></td>
                      <td>Sustainable crops are required for humanity's survival. We identify microbes that confer tolerance to drought, pests, and other stressors in a variety of plants. Additionally, as part of NASA-funded efforts, we are finding microbes that help plants grow in stressful, desertified environments on and off this planet, with the aim of eventually growing crops in lunar soil.</td>
                    </tr>
                  </tbody>
                </table>
                                
                <h2>2FP Open Science and Outreach Initiatives</h2>
                
                <p><strong>Citizen Science:</strong> We have run two citizen science, national sampling campaigns. These programs enable anyone to learn about and collect microbial samples from "the extremophiles in their homes" (e.g., HVAC systems) or "extremophiles in the wild" (hot springs on their property), where we expect carbon and contaminant capturing organisms can be found. A third citizen science campaign, focused on studying aquarium corals, is launching in fall of 2025. [<a href="https://citsci.org/projects/the-extremophile-campaign-in-your-home/" target="_blank">Extremophiles in the home sign-up</a> and <a href="https://www.npr.org/2025/06/02/nx-s1-5419557/these-researchers-think-the-sludge-in-your-home-may-help-save-the-planet" target="_blank">press coverage</a>]</p>
                
                <p><strong>Educational programs:</strong> The 2FP is dedicated to building global research capacity. We provide financial and mentorship support for graduate student researchers, and additionally we run low-cost, modular educational programs for K-12 and undergraduate classes as well as the lay public. Using our standardized sampling kits, we have managed courses in the modern application of DNA sequencing and microbiology around the world.</p>
                
                <p><strong>The 2FP Living Database:</strong> Each of our core research initiatives involves characterizing the microbial life using standardized, low-cost methods. We store every sample we take in a "living database," which contains both living organisms and paired DNA sequencing data. We are dedicated to <strong>Open Science,</strong> enabling this resource to be available to the entire research community. <strong>We provide our open-source tech stack <a href="https://two-frontiers-project.github.io/#/" target="_blank">here</a>.</strong></p>
              </div>
            </div>
          `;
          
          contentArea.innerHTML = aboutContent;
        }
    

    
    // Fix internal links in loaded content
    function fixInternalLinksFromContent(link) {
      const contentDiv = document.querySelector('.markdown-content');
      if (!contentDiv) return;
      
      // Determine the base path for the content
      let basePath = '';
      if (link && link.startsWith('external/')) {
        const pathParts = link.split('/');
        if (pathParts.length >= 3) {
          basePath = pathParts.slice(0, -1).join('/') + '/';
        }
      }
      
      // Fix image sources
      const images = contentDiv.querySelectorAll('img');
      images.forEach(img => {
        const src = img.getAttribute('src');
        if (src && !src.startsWith('http') && !src.startsWith('/') && !src.startsWith('data:')) {
          // Handle handbook images specifically
          if (link && link.includes('2FP-Field-Handbook')) {
            // For handbook content, images should be relative to the handbook directory
            img.src = `external/2FP-Field-Handbook/${src}`;
          } else if (basePath) {
            // For other content, use the base path
            img.src = basePath + src;
          }
        }
      });
      
      // Fix links to handbook files
      const handbookLinks = contentDiv.querySelectorAll('a[href*="github.com/two-frontiers-project/2FP-Field-Handbook"]');
      handbookLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href.includes('blob/main/')) {
          const filename = href.split('blob/main/')[1];
          link.href = `external/2FP-Field-Handbook/${filename}`;
          link.target = '_blank';
        }
      });
      
      // Fix relative links to other markdown files
      const relativeLinks = contentDiv.querySelectorAll('a[href$=".md"]');
      relativeLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href.startsWith('http') && !href.startsWith('#')) {
          if (basePath) {
            link.href = basePath + href;
          } else {
            link.href = `external/2FP-Field-Handbook/${href}`;
          }
          link.target = '_blank';
        }
      });
    }
    
    // Initialize with overview section expanded and load navigation
    document.addEventListener('DOMContentLoaded', function() {
      loadNavigation();
      
      // Automatically load the README content for the home page
      loadContentFromLink('/README.md', 'Welcome to 2FP Open Tools');
    });
  </script>
</body>
</html>
